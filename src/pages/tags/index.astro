---
export const prerender = false;

import HomeSider from '@components/layout/HomeSider.astro';
import { CollapsibleTags } from '@components/tag/CollapsibleTags';
import { TagItem } from '@components/tag/TagItem';
import Cover from '@components/ui/cover/Cover.astro';
import { CONTENT_PADDING } from '@constants/layout';
import { siteConfig } from '@constants/site-config';
import Layout from '@layouts/Layout.astro';
import TwoColumnLayout from '@layouts/TwoColumnLayout.astro';

// 1. 定义 WordPress API 地址
const WP_URL = 'https://www.yuxh.cc';

/**
 * 2. 获取所有标签
 * per_page=100 获取最多100个标签，orderby=count 按文章数排序
 */
const response = await fetch(`${WP_URL}/wp-json/wp/v2/tags?per_page=100&orderby=count&order=desc`);
const rawTags = await response.json();

// 3. 转换为组件需要的格式
// WP 标签对象包含: { name, count, slug, id ... }
const sortedTags = Array.isArray(rawTags)
  ? rawTags.map((t: any, index: number) => ({
      tag: t.name,
      slug: t.slug, // 如果 TagItem 需要跳转，可能用到这个
      count: t.count,
      colorIndex: index % 4,
    }))
  : [];

// 4. 分类标签：多次使用的和只出现一次的
const mainTags = sortedTags.filter(({ count }) => count > 1);
const singleTags = sortedTags.filter(({ count }) => count === 1);
---

<Layout title={`标签 | ${siteConfig.title}`} description="所有文章标签">
  <TwoColumnLayout>
    <Cover slot="cover" title="全部标签" />
    <HomeSider slot="sider" />
    <div class={`shadow-box bg-gradient-start mx-0 flex w-full flex-col ${CONTENT_PADDING.normal}`}>
      <h2 class="shoka-decoration-circle group relative h-19 px-6 py-5 text-2xl/9 font-bold md:text-xl/9">
        <a href="/" class="dashed-border text-muted-foreground group-hover:border-blue group-hover:text-blue border-b">首页</a>
        <span class="text-muted-foreground text-lg md:text-base"> / </span>
        共 {sortedTags.length} 个标签
      </h2>

      <div class="flex flex-wrap gap-3 px-4 md:px-0">
        {mainTags.length > 0 ? (
          mainTags.map((props) => <TagItem {...props} />)
        ) : (
          <p class="text-muted-foreground text-sm">暂无常用标签</p>
        )}
      </div>

      {singleTags.length > 0 && (
        <CollapsibleTags tags={singleTags} client:only="react" />
      )}
    </div>
  </TwoColumnLayout>
</Layout>
