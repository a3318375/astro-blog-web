---
import HomeSider from '@components/layout/HomeSider.astro';
import PostList from '@components/post/PostList.astro';
import Cover from '@components/ui/cover/Cover.astro';
import { CONTENT_PADDING, PAGINATION } from '@constants/layout';
import { seoConfig } from '@constants/site-config';
import Layout from '@layouts/Layout.astro';
import TwoColumnLayout from '@layouts/TwoColumnLayout.astro';
import { transformWPPost } from '@lib/content';
import type { Page } from 'astro';
import type { BlogPost } from 'types/blog';
import CategoryCards from '@/components/post/CategoryCards.astro';
import Divider from '@/components/ui/divider';

// 首页显示前N篇普通文章（不含系列文章）
const { pageSize } = PAGINATION;
const WP_URL = 'https://www.yuxh.cc';

/**
 * 3. 獲取置頂文章 (WP 邏輯：sticky=true)
 * 加上 _embed 以獲取特色圖片和分類名稱
 */
const stickyRes = await fetch(`${WP_URL}/wp-json/wp/v2/posts?sticky=true&per_page=3&_embed`);
const rawStickyItems = await stickyRes.json();

// 轉換置頂文章，WP 若無數據會返回空數組 []
const stickyPosts = Array.isArray(rawStickyItems) ? rawStickyItems.map(transformWPPost) : [];

/**
 * 4. 獲取普通文章列表
 * WP 默認分頁參數為 page (從 1 開始) 和 per_page
 */
const regularRes = await fetch(`${WP_URL}/wp-json/wp/v2/posts?sticky=false&page=1&per_page=${pageSize}&_embed`);
const postsData = await regularRes.json();

// WordPress 的總條數存放在 Response Headers 中
const total = parseInt(regularRes.headers.get('X-WP-Total') || '0');
const totalPage = parseInt(regularRes.headers.get('X-WP-TotalPages') || '0');

const rawRecords = Array.isArray(postsData) ? postsData : [];
const posts = rawRecords.map(transformWPPost);

const page: Page<BlogPost> = {
  data: posts,
  start: 0,
  end: posts.length - 1,
  size: pageSize,
  total: total,
  currentPage: 1,
  lastPage: totalPage,
  url: {
    current: '/',
    prev: undefined,
    next: total > pageSize ? '/posts/2' : undefined,
    first: '/',
    last: `/posts/${Math.ceil(total / pageSize)}`,
  },
};
---

<Layout title={seoConfig.title}>
  <TwoColumnLayout>
    <Cover slot="cover" />
    <HomeSider slot="sider" />
    <div
      class={`bg-gradient-start shadow-box tablet:shadow-none flex flex-col gap-4 overflow-hidden  ${CONTENT_PADDING.standard}`}
    >
      {stickyPosts.length > 0 && (
        <>
          <Divider>置顶文章</Divider>
          <PostList posts={stickyPosts} showPaginator={false} />
        </>
      )}
      <Divider>文章列表</Divider>
      <PostList posts={posts} page={page} showPaginator={true} baseUrl="/posts" isHomePage={true} />
      <Divider className="mt-6">精选分类</Divider>
      <CategoryCards />
    </div>
  </TwoColumnLayout>
</Layout>
